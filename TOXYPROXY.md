### Основы управления Toxiproxy

Все управление происходит через отправку `POST` запросов на API-порт `toxiproxy-server:8474`.

*   **URL:** `http://toxiproxy-server:8474/proxies/{proxy_name}/toxics`
*   **Метод:** `POST`
*   **Тело запроса:** JSON-объект, описывающий "токсин" (toxic) — тип сбоя, который вы хотите симулировать.

Вы будете применять эти токсины к вашим прокси: `toxiproxy-backend-1` и `toxiproxy-backend-2`.

---

### Готовые `curl` команды

Эти команды можно выполнять прямо с вашей хост-машины (если вы пробросили порт 8474), из контейнера `setup` или из любого другого контейнера в той же сети. Я буду использовать `localhost:8474`, но вы можете заменить его на `toxiproxy-server:8474`, если выполняете команду внутри docker-сети.

#### 1. Симуляция сетевой задержки (Latency)

Это самый частый и полезный тест. Он симулирует медленную сеть или перегруженный бэкенд.

**Команда:**
```bash
# Добавить 500ms задержки + 50ms джиттера (случайное отклонение) к бэкенду-1
curl -X POST http://localhost:8474/proxies/toxiproxy-backend-1/toxics \
  -H "Content-Type: application/json" \
  -d '{
    "type": "latency",
    "attributes": {
      "latency": 500,
      "jitter": 50
    }
  }'
```
*   `type: "latency"` — тип токсина.
*   `latency: 500` — основная задержка в миллисекундах.
*   `jitter: 50` — случайная задержка от 0 до 50 мс, которая будет добавляться к основной. Это делает симуляцию более реалистичной.

#### 2. Симуляция медленного соединения (Slow Close)

Этот токсин имитирует ситуацию, когда TCP-соединение закрывается очень медленно, задерживая ресурсы на клиенте и сервере.

**Команда:**
```bash
# Заставить соединение с бэкендом-2 закрываться с задержкой в 1 секунду
curl -X POST http://localhost:8474/proxies/toxiproxy-backend-2/toxics \
  -H "Content-Type: application/json" \
  -d '{
    "type": "slow_close",
    "attributes": {
      "delay": 1000
    }
  }'
```
*   `type: "slow_close"` — тип токсина.
*   `delay: 1000` — задержка в миллисекундах перед полным закрытием сокета после получения FIN.

#### 3. Симуляция полного обрыва соединения (Reset Peer)

Этот токсин резко обрывает соединение, отправляя TCP RST пакет. Ваш прокси должен корректно обработать это как внезапную сетевую ошибку.

**Команда:**
```bash
# Обрывать соединение с бэкендом-1 после 1 секунды
curl -X POST http://localhost:8474/proxies/toxiproxy-backend-1/toxics \
  -H "Content-Type: application/json" \
  -d '{
    "type": "reset_peer",
    "attributes": {
      "timeout": 1000
    }
  }'
```
*   `type: "reset_peer"` — тип токсина.
*   `timeout: 1000` — через сколько миллисекунд после установления соединения его нужно оборвать.

#### 4. Симуляция недоступности бэкенда (Timeout)

Этот токсин заставляет `toxiproxy` перестать читать данные из сокета, что приводит к таймауту на стороне вашего прокси. **Это лучший способ симулировать 504 Gateway Timeout**.

**Команда:**
```bash
# Симулировать таймаут для бэкенда-2, остановив чтение данных
curl -X POST http://localhost:8474/proxies/toxiproxy-backend-2/toxics \
  -H "Content-Type: application/json" \
  -d '{
    "type": "timeout",
    "attributes": {
      "timeout": 0 
    }
  }'
```
*   `type: "timeout"` — тип токсина.
*   `timeout: 0` — `0` означает, что таймаут применяется немедленно и навсегда (пока токсин не будет удален).

#### 5. Симуляция ограниченной пропускной способности (Bandwidth)

Имитирует медленный канал связи (например, мобильный интернет).

**Команда:**
```bash
# Ограничить скорость для бэкенда-1 до 1000 КБ/с
curl -X POST http://localhost:8474/proxies/toxiproxy-backend-1/toxics \
  -H "Content-Type: application/json" \
  -d '{
    "type": "bandwidth",
    "attributes": {
      "rate": 1000 
    }
  }'
```
*   `type: "bandwidth"` — тип токсина.
*   `rate: 1000` — скорость в КБ/с.

#### 6. Симуляция частичной недоступности (Slicer)

Этот токсин "нарезает" TCP-пакеты на очень маленькие части, что может выявить проблемы с буферизацией в вашем коде.

**Команда:**
```bash
# Нарезать данные от бэкенда-2 на куски по 10 байт с задержкой 10 мс между ними
curl -X POST http://localhost:8474/proxies/toxiproxy-backend-2/toxics \
  -H "Content-Type: application/json" \
  -d '{
    "type": "slicer",
    "attributes": {
      "average_size": 10,
      "size_variation": 5,
      "delay": 10
    }
  }'
```

#### Важно: Как симулировать 502/503?

Toxiproxy работает на сетевом уровне (TCP) и **не может генерировать HTTP-ошибки**, такие как `502 Bad Gateway` или `503 Service Unavailable`. Он может только создать условия, при которых ваш прокси, не сумев связаться с бэкендом, **сам сгенерирует** эти ошибки.

*   **Для симуляции 502/503/504:**
    1.  Используйте токсин `timeout` или `reset_peer`.
    2.  Или просто выключите контейнер `minio-1` (`docker-compose stop minio-1`).
    3.  `toxiproxy` не сможет установить соединение с `upstream`, и ваш прокси, получив ошибку "connection refused", должен будет сгенерировать корректный ответ (обычно `502` или `503`).

---

### Управление токсинами

#### Просмотр всех активных токсинов
```bash
curl http://localhost:8474/proxies/toxiproxy-backend-1/toxics
```

#### Удаление токсинов

Чтобы вернуть систему в нормальное состояние, нужно удалить все токсины. Это делается отправкой `DELETE` запроса.

**Команда:**
```bash
# Удалить ВСЕ токсины с бэкенда-1, чтобы вернуть его в нормальное состояние
curl -X DELETE http://localhost:8474/proxies/toxiproxy-backend-1/toxics
```

Это самый частый сценарий: вы включаете сбой, проводите тест, а затем выключаете его этой командой.

#### Обновление токсина

Можно изменить параметры существующего токсина (например, увеличить задержку), отправив `POST` запрос с тем же `type`, но новыми `attributes`.

### Пример тестового сценария

1.  Запускаете `docker-compose up`.
2.  Запускаете ваш Python-скрипт для нагрузочного тестирования в нормальном режиме.
3.  **Вводите сбой:**
    ```bash
    curl -X POST http://localhost:8474/proxies/toxiproxy-backend-1/toxics -d '{"type": "latency", "attributes": {"latency": 1000}}'
    ```
4.  Наблюдаете, как ваш прокси реагирует:
    *   Сработал ли Circuit Breaker для `minio-1`?
    *   Увеличились ли тайминги запросов?
    *   Продолжает ли система работать, используя `minio-2`?
5.  **Убираете сбой:**
    ```bash
    curl -X DELETE http://localhost:8474/proxies/toxiproxy-backend-1/toxics
    ```
6.  Наблюдаете, как система восстанавливается и `minio-1` снова входит в работу.